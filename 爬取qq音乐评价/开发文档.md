

![v2_ba2556139a264d9aaf9ce4b09b59021a_img_png](C:\Users\树枝990\Desktop\v2_ba2556139a264d9aaf9ce4b09b59021a_img_png.png)

# 本案例预计实现功能

1. 爬取评论文本内容
2. 爬取评论发表时间
3. 根据文本信息绘制词云
4. 按月份绘制每个月的评论数量（曲线图）
5. 按时间端绘制每个时间段的评论数量（曲线图）

# 引言

最近听了毛不易的新歌 入海 ，感觉很好听，也很感人，顺便就拿来写了一个Demo，爬取一起qq音乐上这首歌的评论并可视化以下。

# 可视化效果

![image-20200601135535463](C:\Users\树枝990\AppData\Roaming\Typora\typora-user-images\image-20200601135535463.png)



![image-20200601135337714](C:\Users\树枝990\AppData\Roaming\Typora\typora-user-images\image-20200601135337714.png)





# 功能实现一：爬取评论文本内容

首先是分析一波网页。发现点击评论区的页数，网址是不会发生变化的，可以知道该网页是一个通过post加载的网页。F12打开开发者模式，点击Network，选择xhr型数据，然后点击页码，可以发现第一个数据我们需要的。

![image-20200531015545085](C:\Users\树枝990\AppData\Roaming\Typora\typora-user-images\image-20200531015545085.png)



确定了需要数据后，查看一下request url。

![](C:\Users\树枝990\AppData\Roaming\Typora\typora-user-images\image-20200531022626797.png)

通过队比不同评论页的request url后，我发现这两个request url主要在`pagenum`和`lasthotcommentid`两个参数上有所不同，`pagenum`代表页数，`lasthotcommentid`参数具体含义未知，但经过试验，我发现当这个参数为`265408076_215895782_1590847483`时，改变`pagenum`才会使页面发生变化，如果这个参数为`265408076_1152921505019993399_1590855038`则改变pagenum后，页面不会有任何变化。

```

https://c.y.qq.com/base/fcgi-bin/fcg_global_comment_h5.fcg?g_tk_new_20200303=5381&g_tk=5381&loginUin=0&hostUin=0&format=json&inCharset=utf8&outCharset=GB2312&notice=0&platform=yqq.json&needNewCode=0&cid=205360772&reqtype=2&biztype=1&topid=265408076&cmd=8&needmusiccrit=0&pagenum=0&pagesize=25&lasthotcommentid=song_265408076_215895782_1590847483&domain=qq.com&ct=24&cv=10101010

https://c.y.qq.com/base/fcgi-bin/fcg_global_comment_h5.fcg?g_tk_new_20200303=5381&g_tk=5381&loginUin=0&hostUin=0&format=json&inCharset=utf8&outCharset=GB2312&notice=0&platform=yqq.json&needNewCode=0&cid=205360772&reqtype=2&biztype=1&topid=265408076&cmd=8&needmusiccrit=0&pagenum=2&pagesize=25&lasthotcommentid=song_265408076_1152921505019993399_1590855038&domain=qq.com&ct=24&cv=10101010
```

通过以上分析，我们可以得到我们的request url应该为如下格式，通过改变pagenum的值，可以爬取每一页的数据。

```
https://c.y.qq.com/base/fcgi-bin/fcg_global_comment_h5.fcg?g_tk_new_20200303=5381&g_tk=5381&loginUin=0&hostUin=0&format=json&inCharset=utf8&outCharset=GB2312&notice=0&platform=yqq.json&needNewCode=0&cid=205360772&reqtype=2&biztype=1&topid=265408076&cmd=8&needmusiccrit=0&pagenum=0&pagesize=25&lasthotcommentid=song_265408076_215895782_1590847483&domain=qq.com&ct=24&cv=10101010
```

下一步开始分析获取到的json数据。通过python内置的json模块，使用json.loads()读取json数据。从中找到我们需要的数据（这里是rootcommentcontent和time）

```
'comment': {'commentlist': {'avatarurl': 'http://thirdwx.qlogo.cn/mmopen/vi_32/C9xImA5GDR8rdUJSLmk98FuibLgQROKW7mC8IF1CUQnqgSWxgJXI0ZQExmrR5rhyTBxmTvfyn9Bz111YqgBBw1Q/132', 'commentid': 'song_265408076_1152921505024552436_1590864073', 'commit_state': 2, 'enable_delete': 0, 'encrypt_rootcommentuin': 'oK6kowEAoK4z7KnA7e4kowvi7c**', 'encrypt_uin': 'oK6kowEAoK4z7KnA7e4kowvi7c**', 'identity_pic': '', 'identity_type': 0, 'is_hot': 1, 'is_hot_cmt': 0, 'is_medal': 0, 'is_stick': 0, 'ispraise': 0, 'middlecommentcontent': None, 'nick': '夜凄凉�🍃', 'permission': 0, 'praisenum': 0, 'root_enable_delete': 0, 'root_identity_pic': '', 'root_identity_type': 0, 'root_is_stick': 0, 'rootcommentcontent': 何时忘却营营，何时了却这牵挂，我
亲爱的朋友，海洋会回答江湖，江湖回答河流，河流会回答浪潮，浪潮会回答大海', 'rootcommentid': 'song_265408076_1152921505024552436_1590864073', 'rootcommentnick': '@夜凄凉�🍃', 'score': 0, 'taoge_topic':
', 'taoge_url': '', 'time': 1590864073, 'user_type': '', 'vipicon': ''}
```





```
pagenum=1&pagesize=25&lasthotcommentid=song_265408076_2332135386_1590893434&domain=qq.com&ct=24&cv=10101010

pagenum=2&pagesize=25&lasthotcommentid=song_265408076_1554877207_1590892078&domain=qq.com&ct=24&cv=10101010

pagenum=3&pagesize=25&lasthotcommentid=song_265408076_1115019984_1589935798_3433536383_1590882567&domain=qq.com&ct=24&cv=10101010

pagenum=4&pagesize=25&lasthotcommentid=song_265408076_2871438182_1590861982&domain=qq.com&ct=24&cv=10101010

https://c.y.qq.com/base/fcgi-bin/fcg_global_comment_h5.fcg?g_tk_new_20200303=5381&g_tk=5381&loginUin=0&hostUin=0&format=json&inCharset=utf8&outCharset=GB2312&notice=0&platform=yqq.json&needNewCode=0&cid=205360772&reqtype=2&biztype=1&topid=265408076&cmd=8&needmusiccrit=0&pagenum=4&pagesize=25
```



时间戳转换标准时间

```
import datetime
dateArray = datetime.datetime.utcfromtimestamp(1590864073)
```

![image-20200531140118310](C:\Users\树枝990\AppData\Roaming\Typora\typora-user-images\image-20200531140118310.png)

![image-20200531140151650](C:\Users\树枝990\AppData\Roaming\Typora\typora-user-images\image-20200531140151650.png)